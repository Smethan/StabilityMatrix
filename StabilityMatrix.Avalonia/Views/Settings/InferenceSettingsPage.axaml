<controls:UserControlBase
    x:Class="StabilityMatrix.Avalonia.Views.Settings.InferenceSettingsPage"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:StabilityMatrix.Avalonia.Controls"
    xmlns:converters="clr-namespace:StabilityMatrix.Avalonia.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:fluentIcons="clr-namespace:FluentIcons.Avalonia.Fluent;assembly=FluentIcons.Avalonia.Fluent"
    xmlns:inference="clr-namespace:StabilityMatrix.Avalonia.Models.Inference"
    xmlns:lang="clr-namespace:StabilityMatrix.Avalonia.Languages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:mocks="clr-namespace:StabilityMatrix.Avalonia.DesignData"
    xmlns:models="clr-namespace:StabilityMatrix.Core.Models;assembly=StabilityMatrix.Core"
    xmlns:models1="clr-namespace:StabilityMatrix.Core.Models;assembly=StabilityMatrix.Core"
    xmlns:native="clr-namespace:StabilityMatrix.Native;assembly=StabilityMatrix.Native"
    xmlns:sg="clr-namespace:SpacedGridControl.Avalonia;assembly=SpacedGridControl.Avalonia"
    xmlns:system="clr-namespace:System;assembly=System.Runtime"
    xmlns:ui="using:FluentAvalonia.UI.Controls"
    xmlns:vmSettings="clr-namespace:StabilityMatrix.Avalonia.ViewModels.Settings"
    d:DataContext="{x:Static mocks:DesignData.InferenceSettingsViewModel}"
    d:DesignHeight="650"
    d:DesignWidth="900"
    x:DataType="vmSettings:InferenceSettingsViewModel"
    mc:Ignorable="d">

    <controls:UserControlBase.Styles>
        <Style Selector="sg|SpacedGrid &gt; ui|SettingsExpander">
            <Setter Property="Margin" Value="8,0" />
        </Style>
    </controls:UserControlBase.Styles>

    <controls:UserControlBase.Resources>
        <models1:DimensionStringComparer x:Key="DimensionStringComparer" />
    </controls:UserControlBase.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="8,16" Spacing="8">

            <!--  Prompt  -->
            <sg:SpacedGrid RowDefinitions="Auto,*" RowSpacing="4">
                <TextBlock
                    Margin="0,0,0,4"
                    FontWeight="Medium"
                    Text="{x:Static lang:Resources.Label_Prompt}" />
                <!--  Auto Completion  -->
                <ui:SettingsExpander
                    Grid.Row="1"
                    Margin="8,0"
                    Header="{x:Static lang:Resources.Label_AutoCompletion}">

                    <ui:SettingsExpander.IconSource>
                        <controls:FASymbolIconSource Symbol="fa-solid fa-wand-magic-sparkles" />
                    </ui:SettingsExpander.IconSource>

                    <ui:SettingsExpander.Footer>
                        <ToggleSwitch IsChecked="{Binding IsPromptCompletionEnabled}" />
                    </ui:SettingsExpander.Footer>

                    <!--  Tag csv selection  -->
                    <ui:SettingsExpanderItem
                        Content="{x:Static lang:Resources.Label_PromptTags}"
                        Description="{x:Static lang:Resources.Label_PromptTagsDescription}"
                        IconSource="Tag"
                        IsEnabled="{Binding IsPromptCompletionEnabled}">
                        <ui:SettingsExpanderItem.Footer>
                            <ui:FAComboBox ItemsSource="{Binding AvailableTagCompletionCsvs}" SelectedItem="{Binding SelectedTagCompletionCsv}" />
                        </ui:SettingsExpanderItem.Footer>
                    </ui:SettingsExpanderItem>

                    <!--  Tag csv import  -->
                    <ui:SettingsExpanderItem
                        Content="{x:Static lang:Resources.Label_PromptTagsImport}"
                        IconSource="Add"
                        IsEnabled="{Binding IsPromptCompletionEnabled}">
                        <ui:SettingsExpanderItem.Footer>
                            <Button Command="{Binding ImportTagCsvCommand}" Content="Import" />
                        </ui:SettingsExpanderItem.Footer>
                    </ui:SettingsExpanderItem>

                    <!--  Remove underscores  -->
                    <ui:SettingsExpanderItem
                        Content="{x:Static lang:Resources.Label_CompletionReplaceUnderscoresWithSpaces}"
                        IconSource="Underline"
                        IsEnabled="{Binding IsPromptCompletionEnabled}">
                        <ui:SettingsExpanderItem.Footer>
                            <CheckBox Margin="8" IsChecked="{Binding IsCompletionRemoveUnderscoresEnabled}" />
                        </ui:SettingsExpanderItem.Footer>
                    </ui:SettingsExpanderItem>
                </ui:SettingsExpander>
            </sg:SpacedGrid>

            <!--  General  -->
            <sg:SpacedGrid RowDefinitions="Auto,*,*,*" RowSpacing="4">
                <TextBlock
                    Margin="0,0,0,4"
                    FontWeight="Medium"
                    Text="{x:Static lang:Resources.Label_General}" />

                <!--  Filter Extra Networks  -->
                <ui:SettingsExpander
                    Grid.Row="1"
                    Header="Filter Extra Networks by Base Model"
                    IconSource="Filter">
                    <ui:SettingsExpander.Footer>
                        <ToggleSwitch Margin="0,-8,0,-6" IsChecked="{Binding FilterExtraNetworksByBaseModel}" />
                    </ui:SettingsExpander.Footer>
                </ui:SettingsExpander>

                <!--  Image Viewer  -->
                <ui:SettingsExpander
                    Grid.Row="2"
                    Header="{x:Static lang:Resources.Label_ImageViewer}"
                    IconSource="Image"
                    IsExpanded="True">

                    <!--  Pixel grid  -->
                    <ui:SettingsExpanderItem Content="Show pixel grid at high zoom levels" IconSource="ViewAll">
                        <ui:SettingsExpanderItem.Footer>
                            <CheckBox Margin="8" IsChecked="{Binding IsImageViewerPixelGridEnabled}" />
                        </ui:SettingsExpanderItem.Footer>
                    </ui:SettingsExpanderItem>

                    <!--  Recycle Option  -->
                    <ui:SettingsExpanderItem
                        Content="Move files to the Recycle Bin when deleting"
                        Description="If disabled, files will be permanently deleted"
                        IsVisible="{x:Static native:NativeFileOperations.IsRecycleBinAvailable}">
                        <ui:SettingsExpanderItem.IconSource>
                            <fluentIcons:SymbolIconSource Symbol="Delete" />
                        </ui:SettingsExpanderItem.IconSource>
                        <ui:SettingsExpanderItem.Footer>
                            <CheckBox Margin="8" IsChecked="{Binding IsInferenceImageBrowserUseRecycleBinForDelete}" />
                        </ui:SettingsExpanderItem.Footer>
                    </ui:SettingsExpanderItem>

                </ui:SettingsExpander>

                <!--  Output Image Files  -->
                <ui:SettingsExpander
                    Grid.Row="3"
                    Header="{x:Static lang:Resources.Label_OutputImageFiles}"
                    IsExpanded="True">
                    <ui:SettingsExpander.IconSource>
                        <fluentIcons:SymbolIconSource Symbol="TabDesktopImage" />
                    </ui:SettingsExpander.IconSource>
                    <!--  File name pattern  -->
                    <ui:SettingsExpanderItem
                        Content="File name pattern"
                        Description="{Binding OutputImageFileNameFormatSample}"
                        IconSource="Rename">
                        <ui:SettingsExpanderItem.Footer>
                            <TextBox
                                Name="OutputImageFileNameFormatTextBox"
                                MinWidth="150"
                                FontFamily="Cascadia Code,Consolas,Menlo,Monospace,DejaVu Sans Mono,monospace"
                                FontSize="13"
                                Text="{Binding OutputImageFileNameFormat}"
                                Watermark="{x:Static inference:FileNameFormat.DefaultTemplate}" />
                        </ui:SettingsExpanderItem.Footer>
                    </ui:SettingsExpanderItem>
                </ui:SettingsExpander>

                <ui:TeachingTip
                    Title="Format Variables"
                    Grid.Row="3"
                    IsOpen="{Binding #OutputImageFileNameFormatTextBox.IsFocused}"
                    PreferredPlacement="Top"
                    Target="{Binding #OutputImageFileNameFormatTextBox, Mode=OneWay}">
                    <DataGrid AutoGenerateColumns="True" ItemsSource="{Binding OutputImageFileNameFormatVars}" />
                </ui:TeachingTip>

            </sg:SpacedGrid>

            <!--  ComfyUI Server Settings  -->
            <sg:SpacedGrid RowDefinitions="Auto,*,Auto" RowSpacing="4">
                <TextBlock
                    Margin="0,0,0,4"
                    FontWeight="Medium"
                    Text="ComfyUI Server" />

                <ui:SettingsExpander
                    Grid.Row="1"
                    Header="ComfyUI Server URL"
                    IconSource="Link">
                    <ui:SettingsExpander.Footer>
                        <TextBox
                            MinWidth="200"
                            Text="{Binding ComfyUIHost}"
                            Watermark="e.g., https://example.com or localhost:8188" />
                    </ui:SettingsExpander.Footer>
                </ui:SettingsExpander>

                <Expander
                    Grid.Row="2"
                    HorizontalAlignment="Stretch"
                    Classes="settings"
                    IsExpanded="False">
                    <Expander.Header>
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <StackPanel
                                Grid.Column="0"
                                Orientation="Horizontal"
                                Spacing="12">
                                <fluentIcons:SymbolIcon
                                    VerticalAlignment="Center"
                                    FontSize="20"
                                    Symbol="LockClosed" />
                                <StackPanel VerticalAlignment="Center" Spacing="2">
                                    <TextBlock FontWeight="Medium" Text="ComfyUI Authentication Headers" />
                                    <TextBlock
                                        FontSize="12"
                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                        Text="Add custom HTTP headers for authenticating with remote ComfyUI servers"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                            </StackPanel>
                        </Grid>
                    </Expander.Header>

                    <StackPanel Margin="32,8,8,8" Spacing="8">
                        <!--  Command Buttons  -->
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Command="{Binding AddAuthHeaderCommand}" Content="Add Header">
                                <Button.Styles>
                                    <Style Selector="Button /template/ ContentPresenter">
                                        <Setter Property="CornerRadius" Value="4" />
                                    </Style>
                                </Button.Styles>
                            </Button>
                            <Button
                                Command="{Binding RemoveAuthHeaderCommand}"
                                CommandParameter="{Binding #AuthHeadersGrid.SelectedIndex}"
                                Content="Remove Header">
                                <Button.IsEnabled>
                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                        <Binding Path="!ComfyUIAuthHeadersView.IsEmpty" />
                                        <Binding
                                            Converter="{x:Static ObjectConverters.IsNotNull}"
                                            ElementName="AuthHeadersGrid"
                                            Path="SelectedItem" />
                                    </MultiBinding>
                                </Button.IsEnabled>
                                <Button.Styles>
                                    <Style Selector="Button /template/ ContentPresenter">
                                        <Setter Property="CornerRadius" Value="4" />
                                    </Style>
                                </Button.Styles>
                            </Button>
                        </StackPanel>

                        <!--  DataGrid for Headers  -->
                        <DataGrid
                            x:Name="AuthHeadersGrid"
                            MaxHeight="300"
                            HorizontalAlignment="Stretch"
                            AutoGenerateColumns="False"
                            CanUserReorderColumns="False"
                            CanUserResizeColumns="True"
                            CanUserSortColumns="False"
                            GridLinesVisibility="Horizontal"
                            HeadersVisibility="Column"
                            HorizontalScrollBarVisibility="Auto"
                            ItemsSource="{Binding ComfyUIAuthHeadersView}">
                            <DataGrid.Columns>
                                <DataGridTextColumn
                                    Width="2*"
                                    x:DataType="models:HeaderKeyPair"
                                    Binding="{Binding Key, Mode=TwoWay}"
                                    Header="Header Name"
                                    IsReadOnly="False" />
                                <DataGridTextColumn
                                    Width="3*"
                                    x:DataType="models:HeaderKeyPair"
                                    Binding="{Binding Value, Mode=TwoWay}"
                                    Header="Header Value"
                                    IsReadOnly="False" />
                            </DataGrid.Columns>
                        </DataGrid>

                        <!--  Compact Help Text  -->
                        <TextBlock
                            FontSize="11"
                            Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                            TextWrapping="Wrap">
                            <Run FontWeight="SemiBold" Text="Tip: " />
                            <Run Text="Enter header name (e.g., CF-Access-Client-Id, CF-Access-Client-Secret) and value. Double-click cells to edit. Headers are saved automatically." />
                        </TextBlock>

                        <!--  Validation Message  -->
                        <TextBlock
                            FontSize="11"
                            Foreground="{DynamicResource SystemControlErrorTextForegroundBrush}"
                            IsVisible="{Binding AuthHeadersValidationMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                            Text="{Binding AuthHeadersValidationMessage}"
                            TextWrapping="Wrap" />
                    </StackPanel>
                </Expander>
            </sg:SpacedGrid>

            <!--  Dimensions  -->
            <sg:SpacedGrid RowDefinitions="Auto,*,*,*" RowSpacing="4">
                <TextBlock
                    Margin="0,0,0,4"
                    FontWeight="Medium"
                    Text="Dimensions" />

                <!--  Step Change  -->
                <ui:SettingsExpander
                    Grid.Row="1"
                    Description="Controls how much the dimensions increase or decrease per step when adjusting with arrows or scroll."
                    Header="Step Size">
                    <ui:SettingsExpander.IconSource>
                        <controls:FASymbolIconSource Symbol="fa-solid fa-stairs" />
                    </ui:SettingsExpander.IconSource>
                    <ui:SettingsExpander.Footer>
                        <ui:NumberBox
                            LargeChange="16"
                            Maximum="1024"
                            Minimum="8"
                            SmallChange="8"
                            SpinButtonPlacementMode="Inline"
                            ValidationMode="InvalidInputOverwritten"
                            Value="{Binding InferenceDimensionStepChange}" />
                    </ui:SettingsExpander.Footer>
                </ui:SettingsExpander>

                <!--  Favorite Dimensions  -->
                <ui:SettingsExpander
                    Grid.Row="2"
                    Header="Favorite Dimensions"
                    IsExpanded="True">
                    <ui:SettingsExpander.IconSource>
                        <fluentIcons:SymbolIconSource Symbol="Grid" />
                    </ui:SettingsExpander.IconSource>

                    <ui:SettingsExpanderItem>
                        <Grid RowDefinitions="Auto, *">
                            <ui:CommandBar>
                                <ui:CommandBar.PrimaryCommands>
                                    <ui:CommandBarButton
                                        Width="45"
                                        Height="50"
                                        Command="{Binding AddRowCommand}"
                                        IconSource="Add"
                                        Label="{x:Static lang:Resources.Action_Save}" />
                                    <ui:CommandBarButton
                                        Width="45"
                                        Height="50"
                                        Command="{Binding RemoveSelectedRowCommand}"
                                        CommandParameter="{Binding #DimensionsGrid.SelectedItem}"
                                        IconSource="Remove"
                                        Label="{x:Static lang:Resources.Action_Remove}">
                                        <ui:CommandBarButton.IsEnabled>
                                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                <Binding
                                                    Converter="{x:Static ObjectConverters.IsNotNull}"
                                                    ElementName="DimensionsGrid"
                                                    Path="SelectedItem" />
                                            </MultiBinding>
                                        </ui:CommandBarButton.IsEnabled>
                                    </ui:CommandBarButton>
                                </ui:CommandBar.PrimaryCommands>
                            </ui:CommandBar>
                            <DataGrid
                                x:Name="DimensionsGrid"
                                Grid.Row="1"
                                MaxHeight="400"
                                ItemsSource="{Binding FavoriteDimensions}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn
                                        Width="5*"
                                        x:DataType="system:String"
                                        Binding="{Binding .}"
                                        CanUserSort="True"
                                        CustomSortComparer="{StaticResource DimensionStringComparer}"
                                        FontFamily="Cascadia Code,Consolas,Menlo,Monospace,DejaVu Sans Mono,monospace"
                                        Header="Dimension"
                                        SortMemberPath="." />
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </ui:SettingsExpanderItem>
                </ui:SettingsExpander>
            </sg:SpacedGrid>

        </StackPanel>
    </ScrollViewer>
</controls:UserControlBase>
