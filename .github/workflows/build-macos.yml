name: Build macOS

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: false
        description: Version (Semver without leading v)
        default: "0.0.0-dev"
  push:
    branches:
      - main
  pull_request:

jobs:
  build-macos:
    name: Build macOS (arm64)
    env:
      platform-id: osx-arm64
      app-name: "Stability Matrix.app"
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v3

      - name: Set Version from manual input
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Using version ${{ github.event.inputs.version }}"
          echo "RELEASE_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Set Version from commit
        if: github.event_name != 'workflow_dispatch'
        run: |
          echo "Using dev version"
          echo "RELEASE_VERSION=0.0.0-dev.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Set up .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Install dependencies
        run: dotnet restore -p:PublishReadyToRun=true
        
      - name: Check Version
        run: echo $RELEASE_VERSION

      - name: .NET Msbuild (App)
        run: >
          dotnet msbuild ./StabilityMatrix.Avalonia/StabilityMatrix.Avalonia.csproj
          -t:BundleApp -p:UseAppHost=true -p:SelfContained=true
          -p:Configuration=Release -p:RuntimeIdentifier=${{ env.platform-id }}
          -p:Version=$RELEASE_VERSION
          -p:PublishDir=out
          -p:PublishReadyToRun=true
          -p:CFBundleShortVersionString=$RELEASE_VERSION
          -p:CFBundleName="Stability Matrix"
          -p:CFBundleDisplayName="Stability Matrix"
          -p:CFBundleVersion=$RELEASE_VERSION

      - name: Post Build (App)
        run: mkdir -p signing && mv "./StabilityMatrix.Avalonia/out/Stability Matrix.app" "./signing/${{ env.app-name }}"

      - name: Codesign app bundle
        env:
          MACOS_CERTIFICATE: ${{ secrets.PROD_MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.PROD_MACOS_CERTIFICATE_PWD }}
          MACOS_CERTIFICATE_NAME: ${{ secrets.PROD_MACOS_CERTIFICATE_NAME }}
          MACOS_CI_KEYCHAIN_PWD: ${{ secrets.PROD_MACOS_CI_KEYCHAIN_PWD }}
        run: ./Build/codesign_macos.sh "./signing/${{ env.app-name }}"

      - name: Notarize app bundle
        env:
          MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.PROD_MACOS_NOTARIZATION_APPLE_ID }}
          MACOS_NOTARIZATION_TEAM_ID: ${{ secrets.PROD_MACOS_NOTARIZATION_TEAM_ID }}
          MACOS_NOTARIZATION_PWD: ${{ secrets.PROD_MACOS_NOTARIZATION_PWD }}
        run: ./Build/notarize_macos.sh "./signing/${{ env.app-name }}"

      - name: Zip Artifact (App)
        working-directory: signing
        run: zip -r -y "../StabilityMatrix-${{ env.platform-id }}-app.zip" "${{ env.app-name }}"

      - name: Upload Artifact (App)
        uses: actions/upload-artifact@v4
        with:
          name: StabilityMatrix-${{ env.platform-id }}-app-${{ env.RELEASE_VERSION }}
          path: StabilityMatrix-${{ env.platform-id }}-app.zip
          if-no-files-found: error
          
      - uses: actions/setup-node@v4
        with:
          node-version: '20.11.x'
      
      - name: Install dependencies for dmg creation
        run: brew install graphicsmagick imagemagick && npm install --global create-dmg
      
      - name: Create dmg
        working-directory: signing
        run: >
          create-dmg "${{ env.app-name }}" --overwrite --identity "${{ secrets.PROD_MACOS_CERTIFICATE_NAME }}"
          
      - name: Rename dmg
        working-directory: signing
        run: mv "$(find . -type f -name "*.dmg")" "StabilityMatrix-macos-arm64.dmg"
          
      - name: Zip Artifact (dmg)
        working-directory: signing
        run: zip -r -y "../StabilityMatrix-${{ env.platform-id }}-dmg.zip" "StabilityMatrix-macos-arm64.dmg"
        
      - name: Upload Artifact (dmg)
        uses: actions/upload-artifact@v4
        with:
          name: StabilityMatrix-${{ env.platform-id }}-dmg-${{ env.RELEASE_VERSION }}
          path: StabilityMatrix-${{ env.platform-id }}-dmg.zip
          if-no-files-found: error
